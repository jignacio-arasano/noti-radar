<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{fragments :: head}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<main class="container">
  <section class="card">
    <div class="card-header">
      <div>
        <h2 style="margin:0 0 6px 0;">Monitoreo de p√°ginas</h2>
        <div class="hint">CRUD de URLs + estado, con acciones r√°pidas y b√∫squeda client-side.</div>
      </div>
      <div class="toolbar">
        <div class="searchbar">
          <span class="icon">üîé</span>
          <input id="q" type="search" placeholder="Filtrar por URL..." aria-label="Buscar por URL"/>
        </div>
        <a class="btn" href="/pages" title="Refrescar lista">‚ü≤ <span class="txt">Refrescar</span></a>
        <a class="btn btn-primary" href="/pages/new">Ôºã <span class="txt">Agregar URL</span></a>
      </div>
    </div>

    <div class="card-body">
      <div class="table-wrap">
        <table id="pagesTable" class="stack-table">
          <thead>
          <tr>
            <th class="col-id">ID</th>
            <th>URL</th>
            <th>√öltimo chequeo</th>
            <th>√öltima modificaci√≥n</th>
            <th>Estado</th>
            <th style="text-align:right">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="p : ${pages}" th:attr="data-url=${p.url},data-stack-row=${true}">
            <td class="col-id mono" data-label="ID" th:text="${p.id}">1</td>
            <td data-label="URL">
              <a th:href="${p.url}" th:text="${p.url}" target="_blank" rel="noopener">https://...</a>
            </td>
            <td class="mono" data-label="√öltimo chequeo">
              <time th:text="${p.lastChecked != null ? #temporals.format(p.lastChecked, 'dd/MM/yyyy HH:mm') : '-'}"
                    th:attr="datetime=${p.lastChecked != null ? #temporals.formatISO(p.lastChecked) : ''}">
              </time>
            </td>
            <td class="mono" data-label="√öltima modificaci√≥n">
              <time th:text="${p.lastChanged != null ? #temporals.format(p.lastChanged, 'dd/MM/yyyy HH:mm') : '-'}"
                    th:attr="datetime=${p.lastChanged != null ? #temporals.formatISO(p.lastChanged) : ''}">
              </time>
            </td>
            <td data-label="Estado">
              <span th:if="${p.lastError == null}" class="badge badge-ok">OK</span>
              <span th:if="${p.lastError != null}" class="badge badge-err" th:attr="title=${p.lastError}">Error</span>
            </td>
            <td class="actions" data-label="Acciones" style="text-align:right">
              <form th:action="@{'/pages/' + ${p.id} + '/check'}" method="post">
                <button class="btn" type="submit" title="Chequear ahora">‚ü≥ <span class="txt">Check</span></button>
              </form>
              <a class="btn" th:href="@{'/pages/' + ${p.id} + '/versions'}" title="Ver historial">üïò <span class="txt">Versiones</span></a>
              <form th:action="@{'/pages/' + ${p.id} + '/delete'}" method="post"
                    onsubmit="return confirm('¬øEliminar esta URL del monitoreo?')">
                <button class="btn btn-danger" type="submit" title="Eliminar">üóë <span class="txt">Eliminar</span></button>
              </form>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(pages)}">
            <td colspan="6" style="text-align:center;color:var(--muted);padding:18px">
              No hay URLs a√∫n. Hac√© clic en <b>Agregar URL</b> para empezar.
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px" class="hint">
        Consejo: pas√° el mouse por ‚ÄúError‚Äù para ver el detalle (tooltip).
      </div>
    </div>
  </section>
</main>

<script>
  (function(){
    const q = document.getElementById('q');
    const rows = Array.from(document.querySelectorAll('#pagesTable tbody tr'))
                       .filter(tr => tr.hasAttribute('data-url'));
    function apply(){
      const term = (q.value || '').toLowerCase().trim();
      rows.forEach(tr => {
        const url = (tr.getAttribute('data-url') || '').toLowerCase();
        tr.style.display = (!term || url.includes(term)) ? '' : 'none';
      });
    }
    q.addEventListener('input', apply);
  })();
</script>
</body>
</html>
