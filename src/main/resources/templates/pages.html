<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{fragments :: head}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<main class="container"><!-- main-container-open -->
  <section class="card"><!-- section-card-open -->
    <div class="card-header"><!-- card-header-open -->
      <div><!-- header-intro-open -->
        <h2 style="margin:0 0 6px 0;">Monitoreo de p√°ginas</h2>
        <div class="hint">CRUD de URLs + estado, con acciones r√°pidas y b√∫squeda client-side.</div>
      </div><!-- header-intro-close -->
      <div class="toolbar"><!-- toolbar-open -->
        <div class="searchbar"><!-- searchbar-open -->
          <span class="icon">üîé</span>
          <input id="q" type="search" placeholder="Filtrar por URL..." aria-label="Buscar por URL"/>
        </div><!-- searchbar-close -->
        <a class="btn" href="/pages" title="Refrescar lista"><!-- refresh-link-open -->‚ü≤ <span class="txt">Refrescar</span></a><!-- refresh-link-close -->
        <a class="btn btn-primary" href="/pages/new"><!-- add-link-open -->Ôºã <span class="txt">Agregar URL</span></a><!-- add-link-close -->
      </div><!-- toolbar-close -->
    </div><!-- card-header-close -->

    <div class="card-body"><!-- card-body-open -->
      <div class="table-wrap"><!-- table-wrap-open -->
        <table id="pagesTable">
          <thead>
          <tr>
            <th class="col-id">ID</th>
            <th>URL</th>
            <th>√öltimo chequeo</th>
            <th>√öltima modificaci√≥n</th>
            <th>Estado</th>
            <th style="text-align:right">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="p : ${pages}" th:attr="data-url=${p.url}">
            <td class="col-id mono" th:text="${p.id}">1</td>
            <td>
              <a th:href="${p.url}" th:text="${p.url}" target="_blank" rel="noopener"><!-- url-link-open -->https://...</a><!-- url-link-close -->
            </td>
            <td class="mono">
              <time th:text="${p.lastChecked != null ? #temporals.format(p.lastChecked, 'dd/MM/yyyy HH:mm') : '-'}"
                    th:attr="datetime=${p.lastChecked != null ? #temporals.formatISO(p.lastChecked) : ''}">
              </time>
            </td>
            <td class="mono">
              <time th:text="${p.lastChanged != null ? #temporals.format(p.lastChanged, 'dd/MM/yyyy HH:mm') : '-'}"
                    th:attr="datetime=${p.lastChanged != null ? #temporals.formatISO(p.lastChanged) : ''}">
              </time>
            </td>
            <td>
              <span th:if="${p.lastError == null}" class="badge badge-ok">OK</span>
              <span th:if="${p.lastError != null}" class="badge badge-err" th:attr="title=${p.lastError}">Error</span>
            </td>
            <td class="actions" style="text-align:right"><!-- actions-cell-open -->
              <form class="toolbar-form" th:action="@{'/pages/' + ${p.id} + '/check'}" method="post"><!-- form-check-open -->
                <button class="btn" type="submit" title="Chequear ahora"><!-- check-btn-open -->‚ü≥ <span class="txt">Check</span></button><!-- check-btn-close -->
              </form><!-- form-check-close -->
              <a class="btn" th:href="@{'/pages/' + ${p.id} + '/versions'}" title="Ver historial"><!-- versions-link-open -->üïò <span class="txt">Versiones</span></a><!-- versions-link-close -->
              <form class="toolbar-form" th:action="@{'/pages/' + ${p.id} + '/delete'}" method="post"
                    onsubmit="return confirm('¬øEliminar esta URL del monitoreo?')"><!-- form-delete-open -->
                <button class="btn btn-danger" type="submit" title="Eliminar"><!-- delete-btn-open -->üóë <span class="txt">Eliminar</span></button><!-- delete-btn-close -->
              </form><!-- form-delete-close -->
            </td><!-- actions-cell-close -->
          </tr>
          <tr th:if="${#lists.isEmpty(pages)}">
            <td colspan="6" style="text-align:center;color:var(--muted);padding:18px">
              No hay URLs a√∫n. Hac√© clic en <b>Agregar URL</b> para empezar.
            </td>
          </tr>
          </tbody>
        </table>
      </div><!-- table-wrap-close -->

      <div style="margin-top:10px" class="hint"><!-- hint-open -->
        Consejo: pas√° el mouse por ‚ÄúError‚Äù para ver el detalle (tooltip).
      </div><!-- hint-close -->
    </div><!-- card-body-close -->
  </section><!-- section-card-close -->
</main><!-- main-container-close -->

<script>
  (function(){
    const q = document.getElementById('q');
    const rows = Array.from(document.querySelectorAll('#pagesTable tbody tr'))
                       .filter(tr => tr.hasAttribute('data-url'));
    function apply(){
      const term = (q.value || '').toLowerCase().trim();
      rows.forEach(tr => {
        const url = (tr.getAttribute('data-url') || '').toLowerCase();
        tr.style.display = (!term || url.includes(term)) ? '' : 'none';
      });
    }
    q.addEventListener('input', apply);
  })();
</script>
</body>
</html>
