<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{fragments :: head}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<main class="container"><!-- main-container-open -->
  <section class="card"><!-- section-card-open -->
    <div class="card-header"><!-- card-header-open -->
      <div><!-- header-intro-open -->
        <h2 style="margin:0 0 6px 0;">Comparar contenido</h2>
        <div class="hint"><!-- header-hint-open -->
          P√°gina: <a th:href="${page.url}" target="_blank" rel="noopener" th:text="${page.url}"><!-- page-link-open -->URL</a><!-- page-link-close -->
        </div><!-- header-hint-close -->
      </div><!-- header-intro-close -->
      <div class="toolbar"><!-- toolbar-open -->
        <a class="btn" th:href="@{'/pages/' + ${page.id} + '/versions'}"><!-- back-link-open -->‚Üê Volver a versiones</a><!-- back-link-close -->
        <div class="spacer"><!-- spacer-open --></div><!-- spacer-close -->
        <button class="btn" type="button" id="wrapBtn" title="Alternar ajuste de l√≠neas"><!-- wrap-btn-open -->‚Üî Ajuste l√≠neas</button><!-- wrap-btn-close -->
        <button class="btn" type="button" id="syncBtn" title="Alternar scroll sincronizado"><!-- sync-btn-open -->üîó Sync scroll</button><!-- sync-btn-close -->
      </div><!-- toolbar-close -->
    </div><!-- card-header-close -->

    <div class="card-body diff-root wrap"><!-- card-body-open -->
      <div class="diff-grid"><!-- diff-grid-open -->
        <div class="diff-col"><!-- diff-col-left-open -->
          <div class="diff-header"><!-- diff-header-left-open -->
            <b>Versi√≥n seleccionada</b>
            <span class="badge badge-warn"><!-- badge-left-open -->
                <span class="mono"
                      th:text="${#temporals.format(version.createdAt, 'dd/MM/yyyy HH:mm')}">fecha</span>
              </span><!-- badge-left-close -->
          </div><!-- diff-header-left-close -->
          <div class="diff-pre-wrap"><!-- diff-pre-wrap-left-open -->
            <pre id="preLeft" class="mono diff-pre" th:text="${versionContent}"></pre>
          </div><!-- diff-pre-wrap-left-close -->
        </div><!-- diff-col-left-close -->

        <div class="diff-col"><!-- diff-col-right-open -->
          <div class="diff-header"><!-- diff-header-right-open -->
            <b>Versi√≥n actual</b>
            <span class="badge badge-ok"><!-- badge-right-open -->Actual</span><!-- badge-right-close -->
          </div><!-- diff-header-right-close -->
          <div class="diff-pre-wrap"><!-- diff-pre-wrap-right-open -->
            <pre id="preRight" class="mono diff-pre" th:text="${currentContent}"></pre>
          </div><!-- diff-pre-wrap-right-close -->
        </div><!-- diff-col-right-close -->
      </div><!-- diff-grid-close -->

      <div class="hint" style="margin-top:12px"><!-- hint-open -->
        Tip: Us√° <b>‚Üî Ajuste l√≠neas</b> para alternar entre envoltura (sin overflow) y texto sin envolver (con scroll horizontal interno).
      </div><!-- hint-close -->
    </div><!-- card-body-close -->
  </section><!-- section-card-close -->
</main><!-- main-container-close -->

<style>
  .diff-root{ overflow-x: hidden; }
  .diff-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:16px;
    width:100%;
    max-width:100%;
  }
  .diff-col{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .diff-header{display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:0}
  .diff-pre-wrap{
    border:1px solid var(--border);
    border-radius:12px;
    background:var(--bg);
    overflow:hidden;
    max-width:100%;
    box-shadow:var(--shadow);
  }
  .diff-pre{
    margin:0;
    padding:12px;
    max-height:70vh;
    overflow:auto;
    width:100%;
    box-sizing:border-box;
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .diff-root.nowrap .diff-pre{
    white-space:pre;
    word-break:normal;
    overflow-wrap:normal;
  }
  @media (max-width: 900px){
    .diff-grid{ grid-template-columns: 1fr; }
  }
  @media (max-width: 520px){
    .card-header .spacer{display:none}
    .diff-header{flex-direction:column;align-items:flex-start;gap:6px}
    .diff-pre{max-height:60vh}
    .card-body.diff-root{padding-inline:12px}
  }
</style>

<script>
  (function(){
    const root = document.querySelector('.diff-root');
    const btnWrap = document.getElementById('wrapBtn');
    const btnSync = document.getElementById('syncBtn');
    const left = document.getElementById('preLeft');
    const right = document.getElementById('preRight');

    let sync = false;
    let syncing = false;

    btnWrap.addEventListener('click', () => {
      root.classList.toggle('wrap');
      root.classList.toggle('nowrap');
    });

    btnSync.addEventListener('click', () => {
      sync = !sync;
      btnSync.classList.toggle('btn-primary', sync);
      btnSync.title = sync ? 'Scroll sincronizado ON' : 'Alternar scroll sincronizado';
    });

    function syncScroll(from, to){
      if (!sync || syncing) return;
      try{
        syncing = true;
        const vy = from.scrollTop / (from.scrollHeight - from.clientHeight || 1);
        const vx = from.scrollLeft / (from.scrollWidth - from.clientWidth || 1);
        to.scrollTop  = vy * (to.scrollHeight - to.clientHeight);
        to.scrollLeft = vx * (to.scrollWidth  - to.clientWidth);
      } finally {
        syncing = false;
      }
    }
    left.addEventListener('scroll', () => syncScroll(left, right));
    right.addEventListener('scroll', () => syncScroll(right, left));
  })();
</script>
</body>
</html>
